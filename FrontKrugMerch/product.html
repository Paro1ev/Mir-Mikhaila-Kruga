<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background-color: #fff;
      font-family: Arial, sans-serif;
      color: #333;
    }
    .main-title {
      text-align: center;
      font-size: 2.5rem;
      margin: 20px 0;
    }
    .auth-box {
      background-color: #000;
      padding: 30px;
      border-radius: 8px;
      margin: 20px auto;
      max-width: 800px;
      color: white;
    }
    .product-image {
      max-width: 400px;
      border-radius: 8px;
    }
    button {
      background-color: #fff;
      color: #000;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
    }
    .comment {
      background-color: #222;
      border: 1px solid #444;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      color: white;
    }
  </style>
</head>
<body>
  <div id="app" class="product-page">
    <button @click="goBack">‚Üê –ù–∞–∑–∞–¥</button>
    <h1>{{ product.name }}</h1>
    <img :src="product.image" class="product-image">
    <p>–¶–µ–Ω–∞: {{ product.price }}‚ÇΩ</p>
    <p>{{ product.description }}</p>
    <button @click="addToCart">üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    <div v-if="user">
      <h2>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2>
      <textarea v-model="newComment" rows="3" style="width: 100%"></textarea>
      <button @click="addComment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.length }})</h2>
    <div v-for="comment in comments" :key="comment.id" 
         :class="{'admin-comment': user && user.role === 'admin'}" 
         class="comment">
      <p>
        <strong>{{ comment.userName }}</strong>
        <small>{{ formatDate(comment.createdAt) }}</small>
      </p>
      <p>{{ comment.text }}</p>
      <button v-if="user && (user.id === comment.userId || user.role === 'admin')"
              @click="deleteComment(comment.id)">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
  <script>
    const API_URL = "http://localhost:5250";
    const productId = new URLSearchParams(window.location.search).get('id');
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user")) || null;
    new Vue({
      el: '#app',
      data: {
        product: {},
        comments: [],
        newComment: '',
        user: user
      },
      methods: {
        async loadProduct() {
          const response = await fetch(`${API_URL}/products/${productId}`);
          this.product = await response.json();
        },
        async loadComments() {
          const response = await fetch(`${API_URL}/products/${productId}/comments`);
          this.comments = await response.json();
        },
        async addComment() {
          if (!this.newComment.trim()) return;
          try {
            const response = await fetch(`${API_URL}/products/${productId}/comments`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ text: this.newComment })
            });
            if (response.ok) {
              this.newComment = '';
              await this.loadComments();
            }
          } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
          }
        },
        async deleteComment(commentId) {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;
          try {
            const response = await fetch(`${API_URL}/comments/${commentId}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              this.comments = this.comments.filter(c => c.id !== commentId);
            }
          } catch (error) {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
          }
        },
        async addToCart() {
          if (!this.user) {
            alert("–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è");
            return;
          }
          try {
            const response = await fetch(`${API_URL}/cart/add`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                productId: this.product.id,
                quantity: 1
              })
            });
            if (response.ok) {
              alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!");
            } else {
              alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É");
            }
          } catch (error) {
            alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
          }
        },
        formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU');
        },
        goBack() {
          window.history.back();
        }
      },
      async mounted() {
        await this.loadProduct();
        await this.loadComments();
      }
    });
  </script>
</body>
</html>
